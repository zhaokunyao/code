# 名词说明
## 路由器
即为普通的路由器，控制机与各个网络终端都连接到此路由器上。
路由器上面设置的IP地址分配方式为DHCP.

## 控制机
即为我们自己的电脑，在上面安装了我们开发的软件。
控制机只有一台。

## 网络终端
即为其它的电脑或者是手机等网络设备，也就是即将被我们感染的机器。
网络终端可以有无限多个。

# 基本原理介绍
通过修改路由器的设置，把路由器上面的DHCP DNS设置为控制机的IP地址，
这样就使得各台网络终端在连接到路由器获取IP的时候，
会通过DHCP协议把自己(网络终端)的DNS服务器设置为控制机的IP地址;

从而使得各台网络终端在访问任意的域名请求的时候（比如说www.qq.com），
会首先请求控制机上的DNS服务。

控制机收到网络终端的DNS请求之后， 会把域名都解析到控制机自身;

比如说控制机的IP是192.168.199.139
我们把路由器上DHCP DNS设置为上面的IP。
其它的网络终端首次连接到路由器获取IP地址的时候，
就会自动地把自身的DNS服务器设置为上面的IP。
当网络终端在浏览器里面打开 http://www.qq.com  的时候，
会首先询问控制机www.qq.com的IP地址是多少，
控制机上我们的程序会告诉网络终端， 此域名的IP地址是 192.168.199.139（即为控制机的IP地址）
网络终端的浏览器就会把http请求发送给上面的IP，也就是控制机，
控制机上我们的另外一个程序会去获取www.qq.com的正常页面，
并在html源码里面附加上我们的注入js代码，然后控制机把全部的代码返回给网络终端的浏览器。
浏览器完成页面渲染并执行我们的注入js。

当然了，注入的js基本上可以实现任意的网页功能，非常的强大。

总结一下， 
1. 通过路由器的设置修改网络终端上的dns配置，指向控制机
2. 网络终端上的浏览器向控制机发起某域名的dns解析请求
3. 控制机把域名解析到自身的IP上面，并把解析结果告知网络终端
4. 网络终端上的浏览器向控制机发起http请求
5. 控制机获取该域名真正的页面，并在html源码中附加注入js代码，并全部返回给网络终端
6. 网络终端的浏览器把html源码进行渲染，并执行我们注入的js代码。

如果对这个过程还是感觉不太理解的话，可以在网上查一下:
从输入URL 到页面加载完成的过程中都发生了什么事情.


# 安装步骤
## 0. 登录控制机
以管理员(Administrator)用户登录windows 7控制机，确保与路由器正常连接(无线网络或者有线网络均可)，并能正常上网。

## 1. 下载nodejs
控制机使用浏览器打开 https://nodejs.org/en/

下载并安装nodejs v6.11.2 LTS版本.

## 2. 验证nodejs的安装是否正确

2.1 打开一个dos窗口， 输入node -v 并回车， 看是否正常显示nodejs的版本号。
2.2 我的电脑打开 C:\Users\Administrator\AppData\Roaming\npm目录，看里面是否存在一个etc目录。

## 3. 复制文件 
把文件jeff.cmd和`node_modules`目录复制并copy到2.2的目录中。

C:\Users\Administrator\AppData\Roaming\npm整体结构大概是这样的：
其中有etc `node_modules` 两个目录和jeff.cmd一个文件。
`node_modules`中有一个jeff目录
jeff中有bin他`node_modules`两个目录，以及若干js, html, txt文件。

## 4. 获取控制机的"内网"ip地址
可以在dos窗口中输入 ipconfig /all 来查看， 也可以直接在网络连接上点击右键查看。
可以参考 http://jingyan.baidu.com/article/00a07f386bfc1682d128dc64.html
内网ip一般都是10.或者192.168.开头的，貌似也有172.开头的。

## 5. 设置路由器
路由器的DHCP设置可以参考以下网址：
http://jingyan.baidu.com/article/6079ad0e79fce228ff86dbef.html
其中DNS一项设置为控制机的内网ip地址。
视情况重启路由器。


## 6. 再次确认控制机的状况
6.1 查看内网ip地址是否发生变化，此时应无变化。
6.2 看能否正常上网，若不能则需要检查本机的dns设置是否正确。


## 7. 开启注入程序
打开一个dos窗口， 输入 jeff 192.168.199.139 www.qq.com 并回车

第一个参数 192.168.199.139 是控制机的内网ip地址
第二个参数 www.qq.com 是我们要注入的网站地址

这两个参数视情况修改。

回车之后会启动四个服务：
8080 端口上的http server，用来记录网络终端用户提交的用户名密码
53 端口上的dns server，用来做域名解析
80 端口上的http proxy， 用来代理http请求，
443 端口上的https proxy，用来代理https请求。


## 8. 登录网络终端

登录另外一台windows机器， 我用的是win xp，好古老了。
确保它已经连接到同一个路由器，并获取到了ip地址。

## 9. 确认网络终端是否被dns感染
使用ipconfig /all命令或者右键网络连接，查看dns是否为控制机的ip地址。

## 10. 演示注入

网络终端浏览器输入 http://www.taobao.com  一切正常。

网络终端浏览器输入http://www.qq.com 能打开qq首页，并弹出登录窗口，
用户在登录窗口输入qq号和密码并点击登录。

打开 控制机`C:\Users\Administrator\AppData\Roaming\npm\node_modules\jeff\log.txt'
可以看到刚刚用户输入的 qq号和密码。   

# 文件说明
## jeff.cmd 
当我们在dos窗口输入 `jeff ip地址 域名`  的时候，就会调用这个文件
它调用了bin/jeff

## bin/jeff
由jeff.cmd发起调用
它调用了jeff.js

## jeff.js
解析命令行参数，
初始化 dns servr,  http server 和 http(s) proxy


## dns.js
dns服务器的逻辑。

接受网络终端的dns请求， 比如网络终端的请求是：
```
www.qq.com 的ip地址是多少
```
或
```
www.163.com 的ip地址是多少
```
如果网络终端请求的域名是我们需要注入的域名（即dos窗口中jeff的第二个参数），
则发送响应给网络终端
```
www.qq.com 的ip地址是控制机的ip地址
```
如果网络终端请求的域名并非我们需要注入的域名，
则发送请求给google的dns服务器：
```
www.163.com 的ip地址是多少
```
等接受到google dns服务器的响应的时候，把此响应转发给网络终端。

## proxy.js
http和https代理服务器的逻辑。

如果网络终端向控制机发起了https请求， 请求报文和响应报文都是加密的， 
这种情况下我们就直接把网络终端的请求转发给真正的服务器(即qq或taobao的服务器)，
并把服务器的响应转发给网络终端。

如果网络终端向控制机发起了http请求， proxy.js先对请求报文进行分析，
主要是分析网络终端是否在请求我们准备注入的域名的首页， 
如果是首页就立一个flag: is_x
对，我们就只注入首页；  
然后把请求转发给真正的服务器(qq或taobao的服务器)，并等待服务器的响应。

当服务器的响应到来时， proxy.js 先判断is_x是否为true， 也就是说要不要注入，
如果无需注入，则直接把响应转发给网络终端。
如果需要注入， 则调用x.js的go方法， 对服务器的响应做出注入后，再把响应发回给网络终端。

## x.js
负责对服务器的响应进行注入

所谓服务器的响应分为两个部分：header与html.
x.js 首先从tpl.html中读取我们的注入代码，并进行模版变量替换操作，
然后在服务器响应中寻找<body>标签， 并把注入代码附加到<body>标签后面。

可以在网络终端的浏览器中查看源代码， 在 <body>标签后面可以看到被注入的代码。

## tpl.html
就是注入代码了
它实现了一个登录页的弹出窗口。
其中有一个模版变量 ____URL____ 会被x.js替换为控制机收集用户密码的网址。

## httpd.js
它实现了一个极其简单的http server
用户在登录页弹出窗口中输入qq号和密码之后，点击登陆按钮或者直接按回车，
用户的qq号和密码会提交给这个http server，
它会把qq号和密码记录下来到log.txt中。

## log.txt 
httpd.js记录下来的qq号和密码。
一行一个。
格式为:
```
qq号:密码
```

## node modules 目录
是我们的代码依赖的一些公共库。


# 配置文件
无。 
已改成了dos命令行参数。

# 网络终端如何防范

## 原理
通过上述注入原理的分析，
我们可以发现， 一切的不正常均始于网络终端的dns 配置被感染为控制机的ip.
一般来说网络终端并不能去查看或者修改路由器上dns的配置，所以要防范这种注入，
网络终端只能在自身发力， 确保自身的dns配置是正确的。

### 方法一
网络终端连接到路由器并获取到ip地址后，
右键网络连接并修改dns配置为：8.8.8.8 (google的dns服务器)

### 方法二
打开dos窗口，通过命令的形式修改dns配置：
可以参考 http://jingyan.baidu.com/article/a3aad71ace6482b1fb009612.html
```
netsh interface ip set dns name=”本地连接” source=static addr=8.8.8.8
```
这行命令也可以保存为xxx.bat 文件并双击执行。
当然，“本地连接”这四个字需要替换为真实的网络连接的名称。
可以通过  ipconfig /all 来查看全部的网络连接的名称。


# 流程图

## 网络架构
                                          +------------------------------------------------+
                                          |                                                |
                                          |  路 由  器                                     |
                                          |            DHCP settings:                      |
                                          |                                                |
                                          |            dns: 192.168.199.139                +------------------+
                                          |                                                |                  |
                                          |                                                |                  |
                                          |                                                |                  |
                                          |                                                |                  |
                                          |                                                |                  |
                                          |                                                |                  |
                                          +-------+----------------------------------------+                  |
                                                  |                                                           |
                                                  |                                                           |
                                                  |                                                           |
                                                  |                                                           |
                                                  |                                                           |
                                                  |                                                           |
+-----------------------------------------+       |                                +--------------------------+------------------+
|                                         |       |                                |                                             |
|  控 制 机                               |       |                                |     网 络  终 端                            |
|                                         |       |                                |                                             |
|                                         |       |                                |                                             |
|                                         |       |                                |                                             |
|                                         |       |                                |                                             |
|       IP 地 址 : 192.168.199.139        |       |                                |            DNS   192.168.199.139            |
|                                         +-------+                                |                                             |
|                                         |                                        |            IP 地 址: 192.168.199.111        |
|                                         |                                        |                                             |
|                                         |                                        |                                             |
|                                         |                                        |                                             |
+-----------------------------------------+                                        +---------------------------------------------+


## 有注入发生时的交互流程
                                                    +-------------------+                +------------------------+
+------------------+                                |                   |                |                        |
| 网  络  终  端   |                                |控 制 机           |                | Q Q 服 务 器           |
|                  |    www.qq.com 服 务 器 i p 地 址 是 多 少          |            XXXXX                        |
|                  |                                |                   |           X    |                        |
|                  +----------------------------->  |                   |         XX     |                        |
|                  |                                |                   |         X      +------------------------+
|                  |     192.168.199.139            |                   |        X
|                  |                                |                   |       X
|                  | <------------------------------+                   |       X
|                  |                               ++                   |       X
|                  |                                |                   |      XX        +-------------------------+
|                  |  请 返 回 http://www.qq.com 的 页 面 代 码         |  X XX          |                         |
|                  |                                |                   |XX              | taobao 服 务 器         |
|                  +----------------------------->  |                   |                |                         |
|                  |                                |                   |                |                         |
|                  |                                |                   |                |                         |
|                  |                                | 注 入  代 码      |                +-------------------------+
|                  |     页 面 代 码 全 给 你       |                   |
|                  |                                |                   |
|                  |  <-----------------------------+                   |                +--------------------------+
|                  |                               ++                   |                | google dns 服 务 器      |
|                  |       提 交 qq 号 和 密 码     |                   |                |                          |
|                  |  +---------------------------> |保 存 到 log.txt   |                |                          |
|                  |                                |                   |                |                          |
+------------------+                                +-------------------+                |                          |
                                                                                         +--------------------------+

## 无注入发生时的交互流程
                                                   +----------------------+                        +-------------------------+
+-------------------+ www.taobao.com               |                      |   www.taobao.com       |                         |
|  网络终端         | 服务器的ip地址是多少         | 控制机               | +-服务器ip地址是多少-> | google dns 服务器       |
|                   | +--------------------------->+                      |                        | 8.8.8.8                 |
|                   |                              |                      |                        |                         |
|                   |                              |                      |    60.28.242.249       |                         |
|                   |   60.28.242.249              |                      |                        |                         |
|                   |                              |                      | <----------------------+                         |
|                   | <----------------------------+                      |                        |                         |
|                   |                              |                      |                        +-------------------------+
|                   |                              |                      |
|                   |                              |                      |
|                   |                              +----------------------+
|                   |
|                   |
|                   |                                                           +-------------------------+
|                   |     请 返 回 http://www.taobao.com 的 页 面 代 码         |                         |
|                   |                                                           | 淘宝服务器              |
|                   +---------------------------------------------------->      |                         |
|                   |                                                           |                         |
|                   |                                                           |                         |
|                   |           页面代码全给你                                  |                         |
|                   |   <--------------------------------------------------+    |                         |
|                   |                                                      +    |                         |
|                   |                                                           |                         |
|                   |                                                           +-------------------------+
+-------------------+


# 其它
不要连接一些无需密码的公共 wifi，以免被注入攻击。



